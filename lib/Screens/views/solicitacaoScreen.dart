import 'dart:async';
import 'dart:typed_data';
import 'package:flutter/services.dart';
import 'package:flutter/material.dart';
import '../homescreen/HomeScreen.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:intl/intl.dart';
import 'package:connectivity_plus/connectivity_plus.dart';

Uint8List? imageData;
String selectedcode = '';

class FCCApp extends StatefulWidget {
  final String user;
  final String senha;
  const FCCApp({super.key, required this.user, required this.senha});

  @override
  _FCCAppState createState() => _FCCAppState();
}

class _FCCAppState extends State<FCCApp> {
  List<Map<String, dynamic>> rowData = [];
  bool isLoading2 = false;
  bool isImageAvailable = false;
  Map<String, dynamic> selectedrowData = {} ?? {};
  String searchText = '';
  String searchTextminus = '';
  int? selectedIndex;

  bool isLoading = true;
  bool hasError = false;

  ScrollController _scrollController = ScrollController();

  @override
  void initState() {
    super.initState();
    fetchData1();
    _scrollController = ScrollController();
    SystemChrome.setPreferredOrientations([
      DeviceOrientation.landscapeLeft,
      DeviceOrientation.landscapeRight,
    ]);
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  Future<void> fetchData1({int page = 1, int limit = 50}) async {
    setState(() {
      isLoading = true;
      hasError = false;
    });

    final url =
        'http://192.168.0.6:80/REST/ipena_insol/SALDPR?page=$page&limit=$limit';
    final username = widget.user;
    final password = widget.senha;
    final basicAuth =
        'Basic ' + base64Encode(utf8.encode('$username:$password'));

    try {
      final response = await http.get(
        Uri.parse(url),
        headers: {'authorization': basicAuth},
      );

      if (response.statusCode == 200) {
        final decodedData = json.decode(response.body);

        setState(() {
          // Clear previous data before loading new data
          if (page == 1) {
            rowData.clear();
          }

          // Append the new data
          rowData.addAll(List<Map<String, dynamic>>.from(
            decodedData["Dados"].map((item) => {
                  "Codigo": item["Codigo"],
                  "Descrição": item["Descricao"],
                  "Unidade": item["Um"],
                  "Almoxarifado": item["Almox"],
                  "Saldo": item["Saldo"].toString(),
                  "Local Imag": item["Local Imag"],
                  "Imagem": item["Imagem"],
                  "Centro de custo": item["Centro de custo"],
                  "Conta Contabil": item["Conta Contabil"],
                }),
          ));
          isLoading = false;
        });
      } else {
        throw Exception('Falha ao carregar os dados');
      }
    } catch (e) {
      setState(() {
        hasError = true;
        isLoading = false;
      });
      print('Erro ao realizar o GET: $e');
    }
  }

  Future<void> fetchDataof() async {
    // Simulação de dados offline
    setState(() {
      isLoading = true;
      hasError = false;
    });

    // Adicionando mais dados no JSON
    final offlineData = json.decode('''{
    "Dados": [
      {
        "Codigo": "PR11231",
        "Descricao": "SENSOR D-J59L9(DC-24V)",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 7,
        "Local Imag": "        ",
        "Imagem": "0xFFD8FFE000104A46494600010101006000600000FFDB0043000201010201010202020202020202030503030303030604040305070607070706070708090B0908080A0807070A0D0A0A0B0C0C0C0C07090E0F0D0C0E0B0C0C0CFFDB004301020202030303060303060C0807080C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0CFFC0001108005E00B003012200021101031101FFC4001F0000010501010101010100000000000000000102030405060708090A0BFFC400B5100002010303020403050504040000017D01020300041105122131410613516107227114328191A1082342B1C11552D1F02433627282090A161718191A25262728292A3435363738393A434445464748494A535455565758595A636465666768696A737475767778797A838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE1E2E3E4E5E6E7E8E9EAF1F2F3F4F5F6F7F8F9FAFFC4001F0100030101010101010101010000000000000102030405060708090A0BFFC400B51100020102040403040705040400010277000102031104052131061241510761711322328108144291A1B1C109233352F0156272D10A162434E125F11718191A262728292A35363738393A434445464748494A535455565758595A636465666768696A737475767778797A82838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE2E3E4E5E6E7E8E9EAF2F3F4F5F6F7F8F9FAFFDA000C03010002110311003F00EA2F65F26C247FF9E75C7F92915D6F47924FDE799BE4AEA3C543EC761B3FE7AC958FE4C7FF005CEB402BC1FF001F4F3FEEF6799F728D4C49797526FF00F969FF002D2A3AD436A353B1B79A131BDC6CF2A78CFEEF213FE5A0FEFF00F07E4D59815BC2DE28D63C19AC41A8691A85DE957D6E3093DACFE5C95C5FC45F8D5A3FC1EB296EF5CBE810EA07291ECF32597FDCAEDF53F0DEAD6B2BA4D63789247FF4C0853F8818AF817F6C5D724D73E356A9FC70D86CB74127FCB1FF009E9FFB356750D0F6E97FE0A0BE0D86EBFE411ACFFD74FB3249FF00B3D7A0FC35F8F9E12F8AD63E769CF6FA82C727EF225FF47B98EBF3C75299E1D8F1D59F0CF8FEEBE1CF8E2C358B477B736B3A48FE5C9FEB53F8EB1F67500FD387D5BE1EB3C9F6FF000D6B02331FEECDBEB29179527FC0E27AC39B45F879AC5BC696BE20D5BEDF2ECF320FB15BC98FEFFCFE77FEC95F9EFF0012FE3A6B9F1935F92EEFAEE64B6327EE2D41FDDC51D7327519F4FF00DF41234727FCF406ABF781ECCFD0DF11FC3D82CF549174EB9B8B8B3FF966F3C3E44927FC037BD635E7856EC1F92BC2FF0067CFDAE64F0FF84B548FC4B792DFDBE9B02496AC7FE3E643F73CBCFF001D727E30FDB67C59AD4B23E98F0E911FFCB38963DCFF00F7DBD65ED6A07B33E941653C32FEFE0FFBE2A48627FF00961FEB3FE9A57CCFE09FDB1FC616DAA5BA6A0967AB5BCBFEB04B1ED93FF1CAFA6B47D634CF14F862DF57B49E34B2B98FCC490F18A3DA00937DAA5FF5EF55FC9BAB3BADE8F7295CB7893F683F09F86A6F24F886DEF9E2FE082279BF9D6A781BE3A693E339BECFA75FDBDDC9FEB3CB1C4947B4333A8D375EBAB3F91E48E4F37FBE95D043E3690491EFD2EDBFED8BF975CC4566935C95547883F539E05695869D1B9E6E2398E7F791871CD6A0773A478C6D84B06CB578BCCFF6EBB1D3AFDA488398A58B3D3CC1D6B8AF87573A4691753C7AC581BAB796392246593125B39FB938FEFECAD3D33C4F720AC26F2E350B7B24D907DA1DFF00771FFB15A5303B586F2AE59CBFDCAC3B39BF8EB42CE5FEE50057F150F3EED13FE797EF2B1EF6F61F2A4F301327FCB3D82B525924BDD5EE245CFF00ACF2EB1F5881FEDFD7F5AD00CFBB2F11D8952CD2F149143E75D558BC87F75B280093E39F8ABC27A2496567E24D72D2CA21916B0DF491C7FF007C74AFCE2F8AFE219FC4FE38D5F53BA90CB71A8DDBCF213FF2D1DDFBD7DB3F1AB52FEC1F02EB179BCA1B7B47031DEBE06D4BC63FBD748EDF7097AC845660519E07923D9FEB3FDDE2B3357D2E4FB147F27FCB3AD987535BA87F791B7FACF5AD6B7D2ED750B78F37083F0AD3D987B438FB6D3E5693F77149F8558364907CEE65F363E89EB5EF5A67ECEFA7BE8F1EA4358B5B9571C8B794A915575BFD9BEF34E3A76A0CB736FA06AD2491C17B748009648D13CC4503A04DEB8FF787A51513FE207B53C1659A09D278E432C12492274A71D1A612F58A7CFF0079EBD0FC67E12B0F0EDDC62E2C6EA5B6F338B849157CCFAE2AD58E95E1ABB31C7F62BD6B8FEEC930C7F2AE6A9529FB3343CC7ECED6F223C727FABEB8FF009675D8F8B3E21EA0FF00057C39A22CF225BBDC4E67119FF5BB1FFF00B3ADBD6FC2BA159F966E74DB88D3FE984CC3FF0065AE72FF00C13637D7C96D69AA9289BE48E3913A6FACA9D4A66871DE724DFF002CF0FF00EDD5BD3EFE6D1AFADEE6C9FCB9ED64F337A3E335D643F0AC093FE3F2DB7FFD726AA9AD7C2FBAB6F2DD2488F9BF73676A7ED29998BE34FDA27C4BF12EEDCCB7D71656CBC0B4B693CA03FDFF00EFD61787BC4FA8586A7E75BDFCF6CF1F49126715159F842EE2BEB887ECC774526246CF069B3E9D24179E5CC22263E82BA7F7607DB7FB2D7C497F889A042DA9CFF6FBBD3A4D8F21FF00969FF3CF35EF3AC2FF00694A358F2E383EDBFBB9604411C71BFAE2BE1FFD8FFC6EDE1AF1A9B6921482DEFE3DA02BFF00AC74F5FF00C7BF3AFAE7FB5FED1756EBFF002CD3A0AE703BED325CDAC6F5A96737F72B9FD0A578AC53FE99D6C59FF7EBA00B1697525B4787EBD85666B365FE9BE6491B2FB835D3F8C2FECAFAE6792C6C534DB49CFCB6E1FCCF2FE8FD6B9BBDB59ADA38D33B3FDFE6B43329E9B67B657DF56352B3FDD568E8FA6ECB6F9F9A7DE471CE280383F889A0C37BE0BBA81951BED27CB3BC66BC0EF3F67DD213C2FABC935A24B70F227904C638AFA4750B48AE2C3636F71E67DF279AE33C57A4086C767FD34FCEB3A6675363C547ECC7A09D1AEFFD1FE736F1BA9C7FAA93DAB3BC3FFB3E69BAA69378D756A564B681E488A1C6FF00AD7B9D969B0DE6A3701E267804691ED462315AFE32F0368314711D066D4A5867B5469D2FA2449AD661F7D08070C0D69ED0CCF0EF81BF0E20F0D78D585D4AE74778FCCB95913CCD9F4CD7D91FB687C33F83DE24FD94BC3DA27C207B8D4351D33515D4B57D42EA0743F3C3B3C88C391857DE738E9B6BC26F3C167486B87B747960F23CBDFB4F15B5E17D35649A2F99C29B7C3AC6C4093EB57F589FB317B3F7CF9F26F8297FA77DA2CA0B63749623CD68E43906B9DBFF0086F79AD4D2476F6EA82D79774E09AFAA16D23D374FD4EDC5B0F3E6812449F79DC187DF4FA1AE57C37A28D1A5BB648E36925B7EAE335E7FB33A4F9FAEBE136A515A4BE625DC9E50F3785DDFCEB9493C2D77FDA29BB4E9898B9F322B7AFAE9227D5ADEEA1BA0B892D3CBF9062B3749F0D268FE1FBF8A0CC7E747F23B76A3D9967CB17F1B69CBE6149E34EDE62526976BA8789EE9ACADAD8DFDD3A7991885391E5FCFD2BE88BBF87967AA6877714D0472CCFB36B11FEAFE9555BE175A7867439AE34FF320D56DF0B1CD19F2A511B7C920C8F5A29D3A63F687CE1F14B49B9F85FF0012EF74ED46DE6673B669E5116373300C094E8A083904751CD715AE78B60D42478E282CE188FF00CB46E653F8D7DBDF1BFC35AAFC51D3B4DBBF14F9B7FAFE9BA75B5824B711C7FBBB358B6C111C01BC842BF31E76ED1DABC6FC47FB12E99AE69D6F3D942D14D747CB77493091FD056B4E9C3DA07B43CAFE0E6AD1E8FE2AB4BB5686448A4FEF57D97A05C3CF736E5C39CF96F1E0F4AF9FEC3F625BBD074A8E4B4BE91EE41FBBB462BE96F853F0E35AF194BA6D869704935E95D8E59822A2C7F7E424F03359FF00CBC03BED0439122E7F77F5AD887F73FEE7A564D969D3E8FA9496974B89E2FDD381F74BFAD6942715D006A5DE6E2748CA6CF2BF79F2FAD53D6D1EE022754EEFDEBBEF8B7A0D9F87FC67FD9D6B6AB6779631982FA0DCE76DD2FF00AC5CB93C5714D6B25DDD48D1E7CBF6AE8331F15B8FDDED661F5152CF61246BE6051B31D2AC5AC627D95A12439B193FEB9D677038CBCB6F3ED93EE7E55C5F8C6CB26DE300FF00ACEC2BD2753D33665101FDDFB571FE27D29935AB4F37E538F338ACC2A7C0745FB2EF8063F1A6BBA95FDD2584F059C1B92CEF064DD349B20558CE47EF06E67E78F90545E24F87F79E1DD5EE2CA48243F67932CDC600FF0067D7F0A8BC261ED047240B1AFF00BA48AEA44E75ABB8E4BBBA77C7EEE97B40E4381D53C3864D1E76177B5654FB89902A0D134A7B33141F7008FCC7C7735D7F8AECA3B1D32E193E684F551FC3F4AC1D3808E48A49D982CF1FEED476ACFDA07B3F7CAD368FF6892EDDF2A76797C8C56249E1979E193C851B847C915D923D8DCC8FB0B82A9B9E791B827D31EB5269D07DBC3C714B0C292FC91B4C480C3DF038A8343887B35B236FBD4BEE8FF79B463352269B06A76F215E11D3915BFA978296D6C74B171A8C2D78D70E8D02027ECE3DDBF8BA37E74DBAD263D26E3CB519957EF81D0D0674CE42E3C312436B3EC5C663F93DAA38F4678E2595E076B77B7F9CC78627F3AEE745D3C5E48F0B2C51C9D70E4E4D6F7817E01EA7F133E1E78BBC43A75EE9765A7F820A3EA16325CE2F4A3E312A03D5064671C0CD694E98543C9751D365D59E675769BCDD9F7BFD8ACEBAB792CA328C8536379B1E0F4AF423A525B49B4024274F7A93C3BF0FB54F1C6B51695A258DDEABA85E1C41696F0EF7FF0074FA2FBD2A7FC40A94FF0076735A2D87DBF4BE54277F96BA5F08E9B2E89A248BE4DC5BFDB418D6752CA1957FD6283D09E471EF5D47C45D0BC5363E28B61E2DD166F0F5D1B44B386D9EC4DAA18EDD3CB8CF206F62AA3730CEE6E6B36DF5CD417C3AFA45C319AC63BA592DB337FC7A16CE7CB18C7CFB57391FF2CFDE9D4A7FBC35A7FC33374985E49FF7ECF2CC9261C96FCAB5BC820FDC5A96FAD238B4AB79154C93C723C4D32328DE176E14AFF7B83F37B54F2C3F698772F06B411AD25D4D7B234F34D34F71745A49189DD2CCCDF7DC93FC46ABDBCE889B5A339F456C1A9ECF4E95724C6E24574319F4AB5A9C7737BA8FDA2EE3699FD36ED1FA574198DB5D66D923C244A0FA77AA97DAFC63E5042879361C9ED41D11648B29B849EB8AC8F16F87A4974AFDCC8CD26FEC99A8F6604DE24D630C0C72A6247E48615CC78D262FE23F96607CB830303A9A8F52D16F27D3502CA01F42B5CBEA1E03BCBBBFF3A458A43E667818FEB4BD90543D4B42B6FB3E8D66C3612F1E1B07A558B8B5F334EDFF003A7EF3F8457036361AC59DAA285603D77F14E379ADDB2618C8C9E99A8E403AAD4AEFECBA5DC4BF7DA2FE13D2B9CB5B8935DD6C01FBA8E083F7607F0D606B37DA99B39A1796EA112FB66B2FC31737DA05ECEE2F659FCF4C2EF8CFCB59544C0F55D12C6D53489ED0AFEF0B79D13FDE27DCD558DCCCBB137C6DFDD2302B97D2BE22DC69B70EE837129E5F2B4B1FC4992CEFBCCCDBBBFF0075BA573FB3343BFD4D2DAFE182E74D6B98E285238E45B8642FF686DF9C01CED1599736FF006B984A7AC9D78E95E6BA6F89EFE4F11A5D18A2116FF3372CE31FF7CE6BB68BC6405DEE3B367A66BA40EEAF74AD497E1459C761A1E9E96DA75DCF3CBA902BE7B83E44650A93D033A95F979F34FF0074D721E00F1BEBDF0FAEF58862BF7D3D3574FB25E47191FE9106F3F29E0FA27E55A777F1B2D8681FD9D0D84512CBFEB2629BA67F9CF4E711F41F771F745701AAFC4FB23E257F2E1BD292C99566230BF8D5999D8DE583497198FA76A5F0FF0089F55F05EA8D73A4DFDE69D7AE9E5F9B03ED9231ECD5525F1DE9EF711B206F2EA2D63C4DA7CDA9F9B1BC48BE98AC35341B3FC48D7FC59AA5B2EBBAC5FEAEF62DB613793B4AD0A7A02D5ADE26B1FF008A36ED80285674DA14727EFF00F1570BAFF8B2C34DD765F2E78DB3271820E6BAED435B5BC863D9F36C1BDCABE549FF0076AC20741E107B4F10783EF1669E38A5B78B31C7B7E691FD49FF00AE61BFE0469F041BACE371FF003CEB0F4BB7F2226C7EF3ED9CAE38DB5BFA444F169716F3D79FAD69703D08BAE376D19FF7291E7867EF9FF80D73F6EBA80FBD7911FF00B771FE35A7A7BCD3CBFBC757FC315DDEC8E6F685CFECB81C72BFF7CF3566DFC2B04B1FFAB3F953E363174C52DBDF5D1BCD8FE4FE00D1EC83DA11FF00C2230A6370073D30839A49BC0F6BE57FC7BFFE3A2B692DBCE808F31D99BEE93C6DAB6BA779D0FDE347B30F6871F2F802D36F97B21FFBE0D67DD7C2DB2B81F2C283F3AEDEF99627C63E6F5AAF3CE228A5E3FD5F4ACBD98CF3FB8F8356770482A508EB939C566B7C148E2938987FDF4DFE15E952FDD0FF00DDFBDFED52EC3E8B48D0F2D9BE064729F9188FC45636A3FB3F47E6FDC93F315ECCD37953ECDA314C95165979151ECC0F10B6FD9B646EBBE3FA30A93FE141CF6E7991D8FD2BD9A9678FE5DFDE901E0FA9FC05BC3FEACC9F81ACEB7F813771BE7CB671EE6BE85B755987229BF655CE76AEDF4A00F9EAE3E166AB11D9FBDC55197E1AEADE6653CD61EAC2BE949208E6FEF7E42ABED8B7ECDBC7D056607CE36BF0D75482F51DA1497F799E5457572F8435073B1A1C08BFD5E182EEFAD7ADDC2C50CDF77F41515DC11CB2FDC5A39101E78D1089AD638FFD63A6368EB19F71DABA52112008067CA8F1579ADA388EDD89BFFBFB79AAB71108A55FFA69D68E4343FFD9002C20FFD8FFE000104A46494600010101006000600000FFDB0043000201010201010202020202020202030503030303030604040305070607070706070708090B0908080A0807070A0D0A0A0B0C0C0C0C07090E0F0D0C0E0B0C0C0CFFDB004301020202030303060303060C0807080C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0CFFC0001108005E00B003012200021101031101FFC4001F0000010501010101010100000000000000000102030405060708090A0BFFC400B5100002010303020403050504040000017D01020300041105122131410613516107227114328191A1082342B1C11552D1F02433627282090A161718191A25262728292A3435363738393A434445464748494A535455565758595A636465666768696A737475767778797A838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE1E2E3E4E5E6E7E8E9EAF1F2F3F4F5F6F7F8F9FAFFC4001F0100030101010101010101010000000000000102030405060708090A0BFFC400B51100020102040403040705040400010277000102031104052131061241510761711322328108144291A1B1C109233352F0156272D10A162434E125F11718191A262728292A35363738393A434445464748494A535455565758595A636465666768696A737475767778797A82838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE2E3E4E5E6E7E8E9EAF2F3F4F5F6F7F8F9FAFFDA000C03010002110311003F00EA2F65F26C247FF9E75C7F92915D6F47924FDE799BE4AEA3C543EC761B3FE7AC958FE4C7FF005CEB402BC1FF001F4F3FEEF6799F728D4C49797526FF00F969FF002D2A3AD436A353B1B79A131BDC6CF2A78CFEEF213FE5A0FEFF00F07E4D59815BC2DE28D63C19AC41A8691A85DE957D6E3093DACFE5C95C5FC45F8D5A3FC1EB296EF5CBE810EA07291ECF32597FDCAEDF53F0DEAD6B2BA4D63789247FF4C0853F8818AF817F6C5D724D73E356A9FC70D86CB74127FCB1FF009E9FFB356750D0F6E97FE0A0BE0D86EBFE411ACFFD74FB3249FF00B3D7A0FC35F8F9E12F8AD63E769CF6FA82C727EF225FF47B98EBF3C75299E1D8F1D59F0CF8FEEBE1CF8E2C358B477B736B3A48FE5C9FEB53F8EB1F67500FD387D5BE1EB3C9F6FF000D6B02331FEECDBEB29179527FC0E27AC39B45F879AC5BC696BE20D5BEDF2ECF320FB15BC98FEFFCFE77FEC95F9EFF0012FE3A6B9F1935F92EEFAEE64B6327EE2D41FDDC51D7327519F4FF00DF41234727FCF406ABF781ECCFD0DF11FC3D82CF549174EB9B8B8B3FF966F3C3E44927FC037BD635E7856EC1F92BC2FF0067CFDAE64F0FF84B548FC4B792DFDBE9B02496AC7FE3E643F73CBCFF001D727E30FDB67C59AD4B23E98F0E911FFCB38963DCFF00F7DBD65ED6A07B33E941653C32FEFE0FFBE2A48627FF00961FEB3FE9A57CCFE09FDB1FC616DAA5BA6A0967AB5BCBFEB04B1ED93FF1CAFA6B47D634CF14F862DF57B49E34B2B98FCC490F18A3DA00937DAA5FF5EF55FC9BAB3BADE8F7295CB7893F683F09F86A6F24F886DEF9E2FE082279BF9D6A781BE3A693E339BECFA75FDBDDC9FEB3CB1C4947B4333A8D375EBAB3F91E48E4F37FBE95D043E3690491EFD2EDBFED8BF975CC4566935C95547883F539E05695869D1B9E6E2398E7F791871CD6A0773A478C6D84B06CB578BCCFF6EBB1D3AFDA488398A58B3D3CC1D6B8AF87573A4691753C7AC581BAB796392246593125B39FB938FEFECAD3D33C4F720AC26F2E350B7B24D907DA1DFF00771FFB15A5303B586F2AE59CBFDCAC3B39BF8EB42CE5FEE50057F150F3EED13FE797EF2B1EF6F61F2A4F301327FCB3D82B525924BDD5EE245CFF00ACF2EB1F5881FEDFD7F5AD00CFBB2F11D8952CD2F149143E75D558BC87F75B280093E39F8ABC27A2496567E24D72D2CA21916B0DF491C7FF007C74AFCE2F8AFE219FC4FE38D5F53BA90CB71A8DDBCF213FF2D1DDFBD7DB3F1AB52FEC1F02EB179BCA1B7B47031DEBE06D4BC63FBD748EDF7097AC845660519E07923D9FEB3FDDE2B3357D2E4FB147F27FCB3AD987535BA87F791B7FACF5AD6B7D2ED750B78F37083F0AD3D987B438FB6D3E5693F77149F8558364907CEE65F363E89EB5EF5A67ECEFA7BE8F1EA4358B5B9571C8B794A915575BFD9BEF34E3A76A0CB736FA06AD2491C17B748009648D13CC4503A04DEB8FF787A51513FE207B53C1659A09D278E432C12492274A71D1A612F58A7CFF0079EBD0FC67E12B0F0EDDC62E2C6EA5B6F338B849157CCFAE2AD58E95E1ABB31C7F62BD6B8FEEC930C7F2AE6A9529FB3343CC7ECED6F223C727FABEB8FF009675D8F8B3E21EA0FF00057C39A22CF225BBDC4E67119FF5BB1FFF00B3ADBD6FC2BA159F966E74DB88D3FE984CC3FF0065AE72FF00C13637D7C96D69AA9289BE48E3913A6FACA9D4A66871DE724DFF002CF0FF00EDD5BD3EFE6D1AFADEE6C9FCB9ED64F337A3E335D643F0AC093FE3F2DB7FFD726AA9AD7C2FBAB6F2DD2488F9BF73676A7ED29998BE34FDA27C4BF12EEDCCB7D71656CBC0B4B693CA03FDFF00EFD61787BC4FA8586A7E75BDFCF6CF1F49126715159F842EE2BEB887ECC774526246CF069B3E9D24179E5CC22263E82BA7F7607DB7FB2D7C497F889A042DA9CFF6FBBD3A4D8F21FF00969FF3CF35EF3AC2FF00694A358F2E383EDBFBB9604411C71BFAE2BE1FFD8FFC6EDE1AF1A9B6921482DEFE3DA02BFF00AC74F5FF00C7BF3AFAE7FB5FED1756EBFF002CD3A0AE703BED325CDAC6F5A96737F72B9FD0A578AC53FE99D6C59FF7EBA00B1697525B4787EBD85666B365FE9BE6491B2FB835D3F8C2FECAFAE6792C6C534DB49CFCB6E1FCCF2FE8FD6B9BBDB59ADA38D33B3FDFE6B43329E9B67B657DF56352B3FDD568E8FA6ECB6F9F9A7DE471CE280383F889A0C37BE0BBA81951BED27CB3BC66BC0EF3F67DD213C2FABC935A24B70F227904C638AFA4750B48AE2C3636F71E67DF279AE33C57A4086C767FD34FCEB3A6675363C547ECC7A09D1AEFFD1FE736F1BA9C7FAA93DAB3BC3FFB3E69BAA69378D756A564B681E488A1C6FF00AD7B9D969B0DE6A3701E267804691ED462315AFE32F0368314711D066D4A5867B5469D2FA2449AD661F7D08070C0D69ED0CCF0EF81BF0E20F0D78D585D4AE74778FCCB95913CCD9F4CD7D91FB687C33F83DE24FD94BC3DA27C207B8D4351D33515D4B57D42EA0743F3C3B3C88C391857DE738E9B6BC26F3C167486B87B747960F23CBDFB4F15B5E17D35649A2F99C29B7C3AC6C4093EB57F589FB317B3F7CF9F26F8297FA77DA2CA0B63749623CD68E43906B9DBFF0086F79AD4D2476F6EA82D79774E09AFAA16D23D374FD4EDC5B0F3E6812449F79DC187DF4FA1AE57C37A28D1A5BB648E36925B7EAE335E7FB33A4F9FAEBE136A515A4BE625DC9E50F3785DDFCEB9493C2D77FDA29BB4E9898B9F322B7AFAE9227D5ADEEA1BA0B892D3CBF9062B3749F0D268FE1FBF8A0CC7E747F23B76A3D9967CB17F1B69CBE6149E34EDE62526976BA8789EE9ACADAD8DFDD3A7991885391E5FCFD2BE88BBF87967AA6877714D0472CCFB36B11FEAFE9555BE175A7867439AE34FF320D56DF0B1CD19F2A511B7C920C8F5A29D3A63F687CE1F14B49B9F85FF0012EF74ED46DE6673B669E5116373300C094E8A083904751CD715AE78B60D42478E282CE188FF00CB46E653F8D7DBDF1BFC35AAFC51D3B4DBBF14F9B7FAFE9BA75B5824B711C7FBBB358B6C111C01BC842BF31E76ED1DABC6FC47FB12E99AE69D6F3D942D14D747CB77493091FD056B4E9C3DA07B43CAFE0E6AD1E8FE2AB4BB5686448A4FEF57D97A05C3CF736E5C39CF96F1E0F4AF9FEC3F625BBD074A8E4B4BE91EE41FBBB462BE96F853F0E35AF194BA6D869704935E95D8E59822A2C7F7E424F03359FF00CBC03BED0439122E7F77F5AD887F73FEE7A564D969D3E8FA9496974B89E2FDD381F74BFAD6942715D006A5DE6E2748CA6CF2BF79F2FAD53D6D1EE022754EEFDEBBEF8B7A0D9F87FC67FD9D6B6AB6779631982FA0DCE76DD2FF00AC5CB93C5714D6B25DDD48D1E7CBF6AE8331F15B8FDDED661F5152CF61246BE6051B31D2AC5AC627D95A12439B193FEB9D677038CBCB6F3ED93EE7E55C5F8C6CB26DE300FF00ACEC2BD2753D33665101FDDFB571FE27D29935AB4F37E538F338ACC2A7C0745FB2EF8063F1A6BBA95FDD2584F059C1B92CEF064DD349B20558CE47EF06E67E78F90545E24F87F79E1DD5EE2CA48243F67932CDC600FF0067D7F0A8BC261ED047240B1AFF00BA48AEA44E75ABB8E4BBBA77C7EEE97B40E4381D53C3864D1E76177B5654FB89902A0D134A7B33141F7008FCC7C7735D7F8AECA3B1D32E193E684F551FC3F4AC1D3808E48A49D982CF1FEED476ACFDA07B3F7CAD368FF6892EDDF2A76797C8C56249E1979E193C851B847C915D923D8DCC8FB0B82A9B9E791B827D31EB5269D07DBC3C714B0C292FC91B4C480C3DF038A8343887B35B236FBD4BEE8FF79B463352269B06A76F215E11D3915BFA978296D6C74B171A8C2D78D70E8D02027ECE3DDBF8BA37E74DBAD263D26E3CB519957EF81D0D0674CE42E3C312436B3EC5C663F93DAA38F4678E2595E076B77B7F9CC78627F3AEE745D3C5E48F0B2C51C9D70E4E4D6F7817E01EA7F133E1E78BBC43A75EE9765A7F820A3EA16325CE2F4A3E312A03D5064671C0CD694E98543C9751D365D59E675769BCDD9F7BFD8ACEBAB792CA328C8536379B1E0F4AF423A525B49B4024274F7A93C3BF0FB54F1C6B51695A258DDEABA85E1C41696F0EF7FF0074FA2FBD2A7FC40A94FF0076735A2D87DBF4BE54277F96BA5F08E9B2E89A248BE4DC5BFDB418D6752CA1957FD6283D09E471EF5D47C45D0BC5363E28B61E2DD166F0F5D1B44B386D9EC4DAA18EDD3CB8CF206F62AA3730CEE6E6B36DF5CD417C3AFA45C319AC63BA592DB337FC7A16CE7CB18C7CFB57391FF2CFDE9D4A7FBC35A7FC33374985E49FF7ECF2CC9261C96FCAB5BC820FDC5A96FAD238B4AB79154C93C723C4D32328DE176E14AFF7B83F37B54F2C3F698772F06B411AD25D4D7B234F34D34F71745A49189DD2CCCDF7DC93FC46ABDBCE889B5A339F456C1A9ECF4E95724C6E24574319F4AB5A9C7737BA8FDA2EE3699FD36ED1FA574198DB5D66D923C244A0FA77AA97DAFC63E5042879361C9ED41D11648B29B849EB8AC8F16F87A4974AFDCC8CD26FEC99A8F6604DE24D630C0C72A6247E48615CC78D262FE23F96607CB830303A9A8F52D16F27D3502CA01F42B5CBEA1E03BCBBBFF3A458A43E667818FEB4BD90543D4B42B6FB3E8D66C3612F1E1B07A558B8B5F334EDFF003A7EF3F8457036361AC59DAA285603D77F14E379ADDB2618C8C9E99A8E403AAD4AEFECBA5DC4BF7DA2FE13D2B9CB5B8935DD6C01FBA8E083F7607F0D606B37DA99B39A1796EA112FB66B2FC31737DA05ECEE2F659FCF4C2EF8CFCB59544C0F55D12C6D53489ED0AFEF0B79D13FDE27DCD558DCCCBB137C6DFDD2302B97D2BE22DC69B70EE837129E5F2B4B1FC4992CEFBCCCDBBBFF0075BA573FB3343BFD4D2DAFE182E74D6B98E285238E45B8642FF686DF9C01CED1599736FF006B984A7AC9D78E95E6BA6F89EFE4F11A5D18A2116FF3372CE31FF7CE6BB68BC6405DEE3B367A66BA40EEAF74AD497E1459C761A1E9E96DA75DCF3CBA902BE7B83E44650A93D033A95F979F34FF0074D721E00F1BEBDF0FAEF58862BF7D3D3574FB25E47191FE9106F3F29E0FA27E55A777F1B2D8681FD9D0D84512CBFEB2629BA67F9CF4E711F41F771F745701AAFC4FB23E257F2E1BD292C99566230BF8D5999D8DE583497198FA76A5F0FF0089F55F05EA8D73A4DFDE69D7AE9E5F9B03ED9231ECD5525F1DE9EF711B206F2EA2D63C4DA7CDA9F9B1BC48BE98AC35341B3FC48D7FC59AA5B2EBBAC5FEAEF62DB613793B4AD0A7A02D5ADE26B1FF008A36ED80285674DA14727EFF00F1570BAFF8B2C34DD765F2E78DB3271820E6BAED435B5BC863D9F36C1BDCABE549FF0076AC20741E107B4F10783EF1669E38A5B78B31C7B7E691FD49FF00AE61BFE0469F041BACE371FF003CEB0F4BB7F2226C7EF3ED9CAE38DB5BFA444F169716F3D79FAD69703D08BAE376D19FF7291E7867EF9FF80D73F6EBA80FBD7911FF00B771FE35A7A7BCD3CBFBC757FC315DDEC8E6F685CFECB81C72BFF7CF3566DFC2B04B1FFAB3F953E363174C52DBDF5D1BCD8FE4FE00D1EC83DA11FF00C2230A6370073D30839A49BC0F6BE57FC7BFFE3A2B692DBCE808F31D99BEE93C6DAB6BA779D0FDE347B30F6871F2F802D36F97B21FFBE0D67DD7C2DB2B81F2C283F3AEDEF99627C63E6F5AAF3CE228A5E3FD5F4ACBD98CF3FB8F8356770482A508EB939C566B7C148E2938987FDF4DFE15E952FDD0FF00DDFBDFED52EC3E8B48D0F2D9BE064729F9188FC45636A3FB3F47E6FDC93F315ECCD37953ECDA314C95165979151ECC0F10B6FD9B646EBBE3FA30A93FE141CF6E7991D8FD2BD9A9678FE5DFDE901E0FA9FC05BC3FEACC9F81ACEB7F813771BE7CB671EE6BE85B755987229BF655CE76AEDF4A00F9EAE3E166AB11D9FBDC55197E1AEADE6653CD61EAC2BE949208E6FEF7E42ABED8B7ECDBC7D056607CE36BF0D75482F51DA1497F799E5457572F8435073B1A1C08BFD5E182EEFAD7ADDC2C50CDF77F41515DC11CB2FDC5A39101E78D1089AD638FFD63A6368EB19F71DABA52112008067CA8F1579ADA388EDD89BFFBFB79AAB71108A55FFA69D68E4343FFD900",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11245",
        "Descricao": "SOQUETE PARA RELE PTF14A+PYC-A1",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 13,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11261",
        "Descricao": "RASPADOR PS-28",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 1,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11271",
        "Descricao": "RETENTOR NOK TC355511",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 5,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11272",
        "Descricao": "RETENTOR DE OLEO AE-2864-A",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 10,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11279",
        "Descricao": "BUCHA DO MANCHAL Ø INTRNO 45 MM ØEXT.62MM",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 2,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11281",
        "Descricao": "ANEL DE VEDACAO V-28A",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 20,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11286",
        "Descricao": "RASPADOR DSI 125",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 19,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11288",
        "Descricao": "ORING AS 568-273",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 3,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11294",
        "Descricao": "ANEL DE VEDACÃO IS 160X190X14",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 3,
        "Local Imag": "        ",
        "Imagem": "                    ",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      },
      {
        "Codigo": "PR11310",
        "Descricao": "SINALIZADOR 22MM XA2-EVB4LC MONOBLOCO 24V CC/CA VERMELHO",
        "Um": "PC",
        "Almox": "03",
        "Saldo": 22,
        "Local Imag": "PR11310",
        "Imagem": "PR11310",
        "Centro de custo": "3070",
        "Conta Contabil": "11308001"
      }
    ]
  }''');

    // Atualiza o estado com os dados simulados
    setState(() {
      rowData = List<Map<String, dynamic>>.from(
        offlineData["Dados"].map((item) => {
              "Codigo": item["Codigo"],
              "Descrição": item["Descricao"],
              "Unidade": item["Um"],
              "Almoxarifado": item["Almox"],
              "Saldo": item["Saldo"].toString(),
              "Local Imag": item["Local Imag"],
              "Imagem": item["Imagem"],
              "Centro de custo": item["Centro de custo"],
              "Conta Contabil": item["Conta Contabil"],
            }),
      );
      hasError = false;
      isLoading = false;
    });
  }

  // Define variables for pagination
  int currentPage = 0;
  final int itemsPerPage = 50;

  List<Map<String, dynamic>> get paginatedData {
    final filteredData = rowData.where((data) {
      return data["Codigo"]!.toLowerCase().contains(searchText) ||
          data["Descrição"]!.toLowerCase().contains(searchText);
    }).toList();

    final startIndex = currentPage * itemsPerPage;
    final endIndex = startIndex + itemsPerPage;

    return filteredData.sublist(
      startIndex,
      endIndex < filteredData.length ? endIndex : filteredData.length,
    );
  }

  List<Map<String, dynamic>> get paginatedDataminus {
    final filteredData = rowData.where((data) {
      return data["Numero Os"]!.toLowerCase().contains(searchTextminus) ||
          data["Status OS"]!.toLowerCase().contains(searchTextminus);
    }).toList();

    final startIndex = currentPage * itemsPerPage;
    final endIndex = startIndex + itemsPerPage;

    return filteredData.sublist(
      startIndex,
      endIndex < filteredData.length ? endIndex : filteredData.length,
    );
  }

  Map<String, List<Map<String, dynamic>>> filteredCache = {};
  Timer? debounce;

  List<Map<String, dynamic>> getFilteredData(String query) {
    if (filteredCache.containsKey(query)) {
      return filteredCache[query]!;
    }

    final filteredData = rowData.where((data) {
      return data["Codigo"]?.toLowerCase().contains(query) ??
          false || data["Descrição"]?.toLowerCase().contains(query) ??
          false;
    }).toList();

    filteredCache[query] = filteredData;
    return filteredData;
  }

// Use this in your build method instead of rowData

  Widget _buildDataRow1(String title) {
    return Container(
      //  width: MediaQuery.of(context).size.width * 0.8,
      // height: MediaQuery.of(context).size.height * 0.6,
      decoration: BoxDecoration(
        border: Border.all(color: Colors.black, width: 1.0),
      ),
      padding: EdgeInsets.all(16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Text(
                title,
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
              const SizedBox(width: 8),
              Expanded(
                child: TextField(
                  onChanged: (value) {
                    setState(() {
                      searchText = value.toLowerCase();
                      currentPage = 0; // Reset to the first page on new search
                    });
                  },
                  onSubmitted: (value) {
                    setState(() {
                      searchText = value
                          .toLowerCase(); // Optional: you can keep this if ss
                      currentPage = 0; // Reset to the first page on search
                    });
                  },
                  decoration: InputDecoration(
                    hintText: "Pesquise por código ou descrição",
                    suffixIcon: IconButton(
                      icon: Icon(Icons.search),
                      onPressed: () {
                        setState(() {
                          currentPage =
                              0; // Reset to the first page on new search
                        });
                      },
                    ),
                  ),
                ),
              )
            ],
          ),
          SizedBox(height: 10),
          Table(
            border: TableBorder.all(color: Colors.black),
            columnWidths: const {
              0: FlexColumnWidth(0.5),
              1: FlexColumnWidth(2),
              2: FlexColumnWidth(0.5),
              3: FlexColumnWidth(0.5),
              4: FlexColumnWidth(0.5),
            },
            children: [
              TableRow(
                decoration: BoxDecoration(
                  color: Colors.grey[300],
                ),
                children: const [
                  Padding(
                    padding: EdgeInsets.all(8.0),
                    child: Text('Código',
                        style: TextStyle(fontWeight: FontWeight.bold)),
                  ),
                  Padding(
                    padding: EdgeInsets.all(8.0),
                    child: Text('Descrição',
                        style: TextStyle(fontWeight: FontWeight.bold)),
                  ),
                  Padding(
                    padding: EdgeInsets.all(8.0),
                    child: Text('Centro de Custo',
                        style: TextStyle(fontWeight: FontWeight.bold)),
                  ),
                  Padding(
                    padding: EdgeInsets.all(8.0),
                    child: Text('Unidade',
                        style: TextStyle(fontWeight: FontWeight.bold)),
                  ),
                  Padding(
                    padding: EdgeInsets.all(8.0),
                    child: Text('Saldo',
                        style: TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ],
              ),
            ],
          ),
          SizedBox(height: 10),
          Expanded(
            child: SingleChildScrollView(
              child: Table(
                border: TableBorder.all(color: Colors.black),
                columnWidths: const {
                  0: FlexColumnWidth(0.5),
                  1: FlexColumnWidth(2),
                  2: FlexColumnWidth(0.5),
                  3: FlexColumnWidth(0.5),
                  4: FlexColumnWidth(0.5),
                },
                children: paginatedData.map((data) {
                  int index = rowData.indexOf(data);
                  return TableRow(
                    decoration: BoxDecoration(
                      color: selectedIndex == index
                          ? Colors.blue.withOpacity(0.3)
                          : Colors.transparent,
                    ),
                    children: [
                      // Coluna: Código
                      TableCell(
                        child: InkWell(
                          onTap: () {
                            setState(() {
                              selectedIndex = index;
                              selectedrowData = data;
                              selectedcode = data["Codigo"];
                              pegarImagemGet();
                            });
                          },
                          child: Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: Text(data["Codigo"] ?? '',
                                style: TextStyle(fontSize: 14)),
                          ),
                        ),
                      ),

                      // Coluna: Descrição
                      TableCell(
                        child: InkWell(
                          onTap: () {
                            setState(() {
                              selectedIndex = index;
                              selectedrowData = data;
                              selectedcode = data["Codigo"];
                              pegarImagemGet();
                            });
                          },
                          child: Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: Text(data["Descrição"] ?? '',
                                style: TextStyle(fontSize: 14)),
                          ),
                        ),
                      ),

                      // Coluna: Centro de custo
                      TableCell(
                        child: InkWell(
                          onTap: () {
                            setState(() {
                              selectedIndex = index;
                              selectedrowData = data;
                              selectedcode = data["Codigo"];
                              pegarImagemGet();
                            });
                          },
                          child: Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: Text(data["Centro de custo"] ?? '',
                                style: TextStyle(fontSize: 14)),
                          ),
                        ),
                      ),

                      // Coluna: Unidade
                      TableCell(
                        child: InkWell(
                          onTap: () {
                            setState(() {
                              selectedIndex = index;
                              selectedrowData = data;
                              selectedcode = data["Codigo"];
                              pegarImagemGet();
                            });
                          },
                          child: Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: Text(data["Unidade"] ?? '',
                                style: TextStyle(fontSize: 14)),
                          ),
                        ),
                      ),

                      // Coluna: Saldo
                      TableCell(
                        child: InkWell(
                          onTap: () {
                            setState(() {
                              selectedIndex = index;
                              selectedrowData = data;
                              selectedcode = data["Codigo"];
                              pegarImagemGet();
                            });
                          },
                          child: Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: Text(data["Saldo"] ?? '',
                                style: TextStyle(fontSize: 14)),
                          ),
                        ),
                      ),
                    ],
                  );
                }).toList(),
              ),
            ),
          ),
          // Load more button
          // if (isLoading)
          //   Center(child: CircularProgressIndicator()) // Show loading indicator
          // else
          //   TextButton(
          //     onPressed: () {
          //       if (paginatedData.length == itemsPerPage) {
          //         setState(() {
          //           currentPage++;
          //           fetchData1(page: currentPage); // Load more data
          //         });
          //       }
          //     },
          //     child: Text('Load More'),
          //   ),
        ],
      ),
    );
  }

  Future<bool> _showConfirmationDialog(
      BuildContext context, String message) async {
    return await showDialog<bool>(
          context: context,
          barrierDismissible: false,
          builder: (BuildContext context) {
            return AlertDialog(
              title: const Text('Confirmação'),
              content: Text(message),
              actions: [
                TextButton(
                  onPressed: () => Navigator.of(context).pop(false),
                  child: const Text('Cancelar'),
                ),
                ElevatedButton(
                  onPressed: () => Navigator.of(context).pop(true),
                  child: const Text('Confirmar'),
                ),
              ],
            );
          },
        ) ??
        false; // Retorna false se o usuário fechar o diálogo sem escolher
  }

  void _showLoadingDialog(BuildContext context, String message) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return AlertDialog(
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              CircularProgressIndicator(),
              SizedBox(height: 16),
              Text(message),
            ],
          ),
        );
      },
    );
  }

  void _showAlertDialogSus(
      BuildContext context, String title, String message, Color color) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: Text(
            title,
            style: TextStyle(color: color),
          ),
          content: Text(message),
          actions: [
            ElevatedButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('OK'),
            ),
          ],
        );
      },
    );
  }

  void _showAlertDialog(
      BuildContext context, String title, String message, Color color) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: Text(
            title,
            style: TextStyle(color: color),
          ),
          content: Text(message),
          actions: [
            ElevatedButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('OK'),
            ),
          ],
        );
      },
    );
  }

  NumberFormat formatter = NumberFormat("00");
  int nextItemCounter = 0;

  List<Map<String, dynamic>> camposAdd = [];
  Widget _buildDataRow2(String title) {
    return SingleChildScrollView(
      child: Column(
        children: [
          Container(
            // height: MediaQuery.of(context).size.width * 0.6,
            // width: MediaQuery.of(context).size.width * 0.4,
            constraints: BoxConstraints(minHeight: 130, maxHeight: 600),
            decoration: BoxDecoration(
              border: Border.all(color: Colors.black, width: 1.0),
            ),
            padding: EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(
                      "$title",
                      style: const TextStyle(
                          fontSize: 13, fontWeight: FontWeight.bold),
                    ),
                    const SizedBox(width: 1),
                    // Botão de adicionar item
                    TextButton.icon(
                      label: const Text(
                        'Adicionar Item',
                        style: TextStyle(color: Colors.green),
                      ),
                      onPressed: () {
                        setState(() {
                          if (selectedrowData.isNotEmpty) {
                            // Obtém a descrição do item que está sendo adicionado
                            String descricao =
                                selectedrowData['Descrição'] ?? '';

                            // Verifica se já existe um item com a mesma descrição na lista 'camposAdd'
                            bool exists = camposAdd
                                .any((item) => item['descricao'] == descricao);

                            nextItemCounter = camposAdd.length + 1;

                            // Se o item não existir, adiciona; caso contrário, exibe uma mensagem ou realiza outra ação
                            if (!exists) {
                              camposAdd.add({
                                'item': formatter
                                    .format(nextItemCounter)
                                    .toString(),
                                'codigo':
                                    selectedrowData['Codigo'] ?? 'Sem código',
                                'descricao': descricao,
                                'tipo': selectedrowData['Tipo'] ?? '',
                                'unidade': selectedrowData['Unidade'] ?? '',
                                'saldo': selectedrowData['Saldo'] ?? '',
                                'centro de custo':
                                    selectedrowData['Centro de custo'] ?? '',
                                'Imagem': selectedrowData['Imagem'] ?? '',
                                'Almox': selectedrowData['Almoxarifado'] ?? '',
                                'qtd': '',
                                'NumOs': '',
                              });
                            } else {
                              // Exibe uma mensagem informando que o item já foi adicionado
                              ScaffoldMessenger.of(context).showSnackBar(
                                const SnackBar(
                                  content: Text(
                                      'Item já foi adicionado. Selecione outro.'),
                                ),
                              );
                            }
                            WidgetsBinding.instance.addPostFrameCallback((_) {
                              _scrollController.animateTo(
                                _scrollController.position.maxScrollExtent,
                                duration: Duration(milliseconds: 300),
                                curve: Curves.easeOut,
                              );
                            });
                          }
                        });
                      },
                    ),
                    // Botão de cancelar todas as adições
                    TextButton.icon(
                      label: const Text(
                        'Cancelar',
                        style: TextStyle(color: Colors.red),
                      ),
                      onPressed: () {
                        setState(() {
                          camposAdd.clear(); // Cancela todas as adições
                          isImageAvailable = false;
                        });
                        isImageAvailable = false;
                      },
                    ),
                    // Botão para solicitar envio
                    TextButton.icon(
                      icon: const Icon(Icons.send,
                          color: Colors.blueAccent, size: 12),
                      label: const Text(
                        'Solicitar',
                        style: TextStyle(color: Colors.blueAccent),
                      ),
                      onPressed: (camposAdd
                                  .any((campo) => campo['isInvalid'] == true) ||
                              !camposAdd.any(
                                  (campo) => campo.containsKey('isInvalid')) ||
                              (camposAdd.any((campo) => campo['qtd'] == '')))
                          ? null
                          : () async {
                              // Verifica se há algum item com código iniciando com PR e sem NumOs
                              final prInvalido = camposAdd.any((campo) {
                                final codigo =
                                    campo['codigo']?.toString() ?? '';
                                final numOs = campo['NumOs']?.toString() ?? '';
                                return codigo.startsWith('PR') && numOs.isEmpty;
                              });

                              if (prInvalido) {
                                await showDialog(
                                  context: context,
                                  builder: (_) => AlertDialog(
                                    title: Text('Número da OS obrigatório'),
                                    content: Text(
                                        'Para itens com código iniciando com "PR", é obrigatório informar o número da OS.'),
                                    actions: [
                                      TextButton(
                                        onPressed: () => Navigator.pop(context),
                                        child: Text('OK'),
                                      ),
                                    ],
                                  ),
                                );
                                return; // Impede o envio
                              }

                              // Mostra o alerta de confirmação normalmente
                              bool confirm = await _showConfirmationDialog(
                                context,
                                'Deseja enviar os dados?',
                              );

                              if (confirm) {
                                _showLoadingDialog(
                                    context, 'Enviando dados...');
                                try {
                                  await postData2();
                                } catch (error) {
                                  // lidar com erro se necessário
                                }
                              }

                              print('Campos adicionados: $camposAdd');
                            },
                    ),
                  ],
                ),

                SizedBox(height: 10),

                // Campo de imagem mantido

                // Tabela que exibe os campos adicionados
                Table(
                  border: TableBorder.all(color: Colors.black),
                  columnWidths: const {
                    0: FlexColumnWidth(0.25),
                    1: FlexColumnWidth(0.4),
                    2: FlexColumnWidth(0.4),
                    3: FlexColumnWidth(0.5),
                    4: FlexColumnWidth(0.9),
                  },
                  children: [
                    TableRow(
                      decoration: BoxDecoration(
                        color: Colors.grey[300],
                      ),
                      children: const [
                        Padding(
                          padding: EdgeInsets.all(8.0),
                          child: Text('Item',
                              style: TextStyle(
                                  fontWeight: FontWeight.bold, fontSize: 12)),
                        ),
                        Padding(
                          padding: EdgeInsets.all(8.0),
                          child: Text('Código',
                              style: TextStyle(
                                  fontWeight: FontWeight.bold, fontSize: 12)),
                        ),
                        // Padding(
                        //   padding: EdgeInsets.all(8.0),
                        //   child: Text('Descrição',
                        //       style: TextStyle(
                        //           fontWeight: FontWeight.bold, fontSize: 12)),
                        // ),
                        Padding(
                          padding: EdgeInsets.all(8.0),
                          child: Text('Centro de Custo',
                              style: TextStyle(
                                  fontWeight: FontWeight.bold, fontSize: 12)),
                        ),
                        Padding(
                          padding: EdgeInsets.all(8.0),
                          child: Text('Num Os',
                              style: TextStyle(
                                  fontWeight: FontWeight.bold, fontSize: 12)),
                        ),
                        Padding(
                          padding: EdgeInsets.all(8.0),
                          child: Text('Quantidade',
                              style: TextStyle(
                                  fontWeight: FontWeight.bold, fontSize: 12)),
                        ),
                      ],
                    ),
                  ],
                ),
                SizedBox(height: 10),
                Container(
                  constraints: BoxConstraints(minHeight: 0, maxHeight: 120),
                  width: double.infinity,
                  child: SingleChildScrollView(
                    controller: _scrollController,
                    child: Column(
                      children: [
                        Table(
                          border: TableBorder.all(color: Colors.black),
                          columnWidths: const {
                            0: FlexColumnWidth(0.25),
                            1: FlexColumnWidth(0.4),
                            2: FlexColumnWidth(0.4),
                            3: FlexColumnWidth(0.5),
                            4: FlexColumnWidth(0.9),
                          },
                          children: camposAdd.map((campo) {
                            return TableRow(
                              children: [
                                Padding(
                                  padding: const EdgeInsets.all(8.0),
                                  child: Text(
                                      style: TextStyle(fontSize: 10),
                                      campo['item'] ?? ''),
                                ),
                                Padding(
                                  padding: const EdgeInsets.all(8.0),
                                  child: Text(
                                      style: TextStyle(fontSize: 10),
                                      campo['codigo'] ?? ''),
                                ),
                                // Padding(
                                //   padding: const EdgeInsets.all(8.0),
                                //   child: Text(
                                //       style: TextStyle(fontSize: 10),
                                //       campo['descricao'] ?? ''),
                                // ),
                                GestureDetector(
                                  onTap: () {
                                    setState(() {
                                      campo['editando'] = true;
                                    });
                                  },
                                  child: campo['editando'] == true
                                      ? Padding(
                                          padding: const EdgeInsets.all(8.0),
                                          child: Focus(
                                            onFocusChange: (hasFocus) {
                                              if (!hasFocus) {
                                                setState(() {
                                                  campo['editando'] = false;
                                                });
                                              }
                                            },
                                            child: TextField(
                                              autofocus:
                                                  true, // Para focar automaticamente ao clicar
                                              onSubmitted: (value) {
                                                setState(() {
                                                  campo['centro de custo'] =
                                                      value;
                                                  campo['editando'] = false;
                                                });
                                              },
                                              decoration: InputDecoration(
                                                border: OutlineInputBorder(),
                                                isDense: true,
                                                contentPadding:
                                                    EdgeInsets.all(8),
                                              ),
                                              style: TextStyle(fontSize: 10),
                                            ),
                                          ),
                                        )
                                      : Padding(
                                          padding: const EdgeInsets.all(8.0),
                                          child: Text(
                                            campo['centro de custo'] ?? '',
                                            style: TextStyle(fontSize: 10),
                                          ),
                                        ),
                                ),

                                Padding(
                                  padding: const EdgeInsets.all(8.0),
                                  child: Row(
                                    children: [
                                      Expanded(
                                          child: Text(
                                              style: TextStyle(fontSize: 10),
                                              campo['NumOs'] ?? '')),
                                      IconButton(
                                        onPressed: () async {
                                          final result =
                                              await _showPopupMenu_Osnew(
                                                  context,
                                                  campo['NumOs'] ?? '');
                                          if (result != null) {
                                            setState(() {
                                              campo['NumOs'] = result;
                                            });
                                          }
                                        },
                                        icon: Icon(
                                          Icons.search,
                                          color: (campo['NumOs'] != null &&
                                                  campo['NumOs']
                                                      .toString()
                                                      .isNotEmpty)
                                              ? Colors.blue
                                              : Colors.black,
                                        ),
                                        tooltip: (campo['NumOs'] != null &&
                                                campo['NumOs']
                                                    .toString()
                                                    .isNotEmpty)
                                            ? campo['NumOs'].toString()
                                            : 'Pesquise a OS',
                                      ),
                                    ],
                                  ),
                                ),
                                Padding(
                                  padding: const EdgeInsets.all(8.0),
                                  child: Row(
                                    children: [
                                      Expanded(
                                        child: TextField(
                                          inputFormatters: [
                                            FilteringTextInputFormatter
                                                .digitsOnly
                                          ],
                                          keyboardType: TextInputType
                                              .number, // Garante entrada numérica
                                          onChanged: (value) {
                                            setState(() {
                                              campo['qtd'] = value;
                                              campo['isInvalid'] =
                                                  (double.tryParse(value) !=
                                                          null &&
                                                      double.parse(value) <= 0);
                                            });
                                          },
                                          decoration: InputDecoration(
                                            border: OutlineInputBorder(),
                                            hintText: 'Digite a quantidade',
                                            errorText:
                                                campo['isInvalid'] == true
                                                    ? 'Valor Invalido'
                                                    : null, // Mensagem de erro
                                            errorBorder: OutlineInputBorder(
                                              borderSide: BorderSide(
                                                  color: Colors.red, width: 2),
                                            ),
                                            focusedBorder: OutlineInputBorder(
                                              borderSide: BorderSide(
                                                color:
                                                    campo['isInvalid'] == true
                                                        ? Colors.red
                                                        : Colors.blue,
                                                width: 2,
                                              ),
                                            ),
                                          ),
                                        ),
                                      ),
                                      IconButton(
                                        icon: Icon(Icons.delete,
                                            color: Colors.red),
                                        onPressed: () {
                                          setState(() {
                                            camposAdd.remove(campo);

                                            for (int i = 0;
                                                i < camposAdd.length;
                                                i++) {
                                              camposAdd[i]['item'] =
                                                  formatter.format(i + 1);
                                            }

                                            // Atualiza o contador com a nova quantidade de itens
                                            nextItemCounter = camposAdd.length;
                                          });
                                        },
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            );
                          }).toList(),
                        ),
                      ],
                    ),
                  ),
                ),

                SizedBox(height: 10),

                Container(
                  width: MediaQuery.of(context).size.width * 0.4,
                  height: MediaQuery.of(context).size.height * 0.24,
                  decoration: BoxDecoration(
                    border: Border.all(color: Colors.black, width: 1.0),
                  ),
                  child: isLoading2
                      ? Center(child: CircularProgressIndicator())
                      : isImageAvailable
                          ? Image.memory(imageBytes!)
                          : Center(child: Text('Imagem não disponível')),
                ),

                SizedBox(height: 10),
              ],
            ),
          ),
          SizedBox(
            height: 20,
          ),

          // Botões de ação
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
            crossAxisAlignment: CrossAxisAlignment.center,
            children: [],
          )
        ],
      ),
    );
  }

  String sucessomessage = '';
  String errormessage = '';
  Map<String, Object> jsoncorpo = {};
  Future<void> postData2() async {
    final url = 'http://192.168.0.6:80/REST/ipena_insol/CRIASA';
    final username = widget.user;
    final password = widget.senha;
    final basicAuth =
        'Basic ' + base64Encode(utf8.encode('$username:$password'));
    camposAdd;
    final body = {
      "CP_NUM": "",
      "CP_EMISSAO": "",
      "CP_SOLICIT": "",
      "CRIASA": camposAdd.map((campo) {
        return {
          "item": campo['item'] ?? '',
          "Codigo": campo['codigo'] ?? '',
          "Descricao": campo['descricao'] ?? '',
          "Um": campo['unidade'] ?? '',
          "qtd": int.tryParse(campo['qtd'] ?? '0') ?? 0,
          "NumOs": campo['NumOs'],
          "Conta Contabil": campo['conta contabil'] ?? '',
          "Centro de Custo": (campo['centro de custo'] ?? '').toString(),
          "Almox": campo['Almox'] ?? '',
          "Obs": campo['obs'] ?? '',
        };
      }).toList(),
    };

    print(jsonEncode(body));
    jsoncorpo = body;

    try {
      final response = await http
          .post(
            Uri.parse(url),
            headers: {
              'Content-Type': 'application/json',
              'Authorization': basicAuth,
            },
            body: jsonEncode(body),
          )
          .timeout(Duration(seconds: 10)); // Timeout de 10 segundos

      if (response.statusCode >= 200 && response.statusCode <= 299) {
        isImageAvailable = false;
        setState(() {
          Navigator.of(context).pop();
          camposAdd.clear();
          isImageAvailable = false;

          final Map<String, dynamic> responseBody = jsonDecode(response.body);
          sucessomessage = responseBody['note'] ?? 'Erro desconhecido';

          _showAlertDialogSus(
            context,
            'Sucesso',
            'Dados enviados com sucesso! $sucessomessage',
            Colors.green,
          );
        });
      } else {
        _handleError();
      }
    } on TimeoutException {
      _handleError('Erro na inclusão do registro. Tente novamente.');
    } catch (e) {
      _handleError('Erro inesperado: $e');
    }
  }

  void _handleError([String message = 'Erro na inclusão do registro']) {
    isImageAvailable = false;
    Navigator.of(context).pop();

    _showAlertDialogSus(
      context,
      'Aviso',
      message,
      Colors.red,
    );

    setState(() {
      camposAdd.clear();
    });
  }

  Future<void> fetchDataimg() async {
    final apiUrl = 'https://picsum.photos/200/300';
    print(selectedcode);
    try {
      final response = await http.get(
        Uri.parse(apiUrl),
      );

      if (response.statusCode == 200) {
        print('ok');
        imageData = response.bodyBytes;
      } else {}
    } catch (e) {}
  }

  List<Map<String, dynamic>> ordensDeServico = [];

  Future<List<Map<String, dynamic>>> fetchDaOsOffline() async {
    // Simula um tempo de espera, se necessário
    await Future.delayed(const Duration(milliseconds: 500));

    const jsonString = '''
  {
    "Dados": [
      {
        "Numero Os": "019942",
        "Data Emissao": "31/12/2000",
        "Status OS": "A",
        "Emitente OS": "VITOR MONTEIRO RODRIGUES"
      },
      {
        "Numero Os": "019925",
        "Data Emissao": "31/01/2020",
        "Status OS": "A",
        "Emitente OS": "BRUNA KELLEN PEDROSA GOMES"
      },
      {
        "Numero Os": "019997",
        "Data Emissao": "03/02/2020",
        "Status OS": "A",
        "Emitente OS": "ALEXANDRO OKI GRACA"
      }
    ]
  }
  ''';

    final Map<String, dynamic> data = json.decode(jsonString);
    final List<dynamic> dados = data['Dados'];
    return List<Map<String, dynamic>>.from(dados);
  }

  Future<List<Map<String, dynamic>>> fetchDaOs() async {
    final username = widget.user;
    final password = widget.senha;
    final basicAuth =
        'Basic ' + base64Encode(utf8.encode('$username:$password'));

    final url = 'http://192.168.0.6:80/REST/ipena_insol/BUSCAOS';

    try {
      final response = await http.get(
        Uri.parse(url),
        headers: {'Authorization': basicAuth},
      );

      List<Map<String, dynamic>> itemsList = [];

      if (response.statusCode == 200) {
        final Map<String, dynamic> data = json.decode(response.body);
        itemsList = List<Map<String, dynamic>>.from(data['Dados']);
        setState(() {
          ordensDeServico = itemsList;
        });
        return List<Map<String, dynamic>>.from(data['Dados']);
      } else {
        print('errodasdasdasdasdr');
        Navigator.of(context).pop();
        throw [];
      }
    } catch (error) {
      print('Error: $error');
      Navigator.of(context).pop();
      return [];
      // Return an empty list in case of an error
    }
  }

  Future<String?> _showPopupMenu_Os(
      BuildContext context, String controller) async {
    final GlobalKey<State> _keyLoader = GlobalKey<State>();

    // Verifica a conexão com a internet
    var connectivityResult = await Connectivity().checkConnectivity();
    if (connectivityResult == ConnectivityResult.none) {
      _showErrorDialog(context, "Sem conexão com a internet.");
      return null;
    }

    // Exibe o diálogo de carregamento
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return Dialog(
          key: _keyLoader,
          child: Container(
            height: 100,
            padding: const EdgeInsets.all(16),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: const [
                CircularProgressIndicator(),
                SizedBox(width: 20),
                Text('Carregando...'),
              ],
            ),
          ),
        );
      },
    );

    try {
      final List<Map<String, dynamic>> items = await fetchDaOs().timeout(
        const Duration(seconds: 18),
        onTimeout: () {
          throw TimeoutException("O tempo limite foi excedido.");
        },
      );

      Navigator.of(_keyLoader.currentContext!, rootNavigator: true)
          .pop(); // Fecha o diálogo de carregamento

      final selected = await showModalBottomSheet<String>(
        context: context,
        isScrollControlled: true,
        builder: (BuildContext context) {
          String searchText = "";
          return StatefulBuilder(
            builder: (context, setState) {
              final List<Map<String, dynamic>> filteredItems =
                  items.where((item) {
                final os = (item['Numero Os']?.toString() ?? "").toLowerCase();
                final emit =
                    (item['Emitente OS']?.toString() ?? "").toLowerCase();
                return os.contains(searchText) || emit.contains(searchText);
              }).toList();

              return SafeArea(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    const Padding(
                      padding: EdgeInsets.all(16.0),
                      child: Text(
                        'Selecione a Ordem de Serviço:',
                        style: TextStyle(
                            fontSize: 18, fontWeight: FontWeight.bold),
                      ),
                    ),
                    Padding(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 16.0, vertical: 8.0),
                      child: TextField(
                        autofocus: true,
                        decoration: const InputDecoration(
                          hintText: "Pesquise por OS ou Emitente",
                          prefixIcon: Icon(Icons.search),
                          border: OutlineInputBorder(),
                        ),
                        onChanged: (value) {
                          setState(() {
                            searchText = value.toLowerCase();
                          });
                        },
                      ),
                    ),
                    Expanded(
                      child: ListView.builder(
                        shrinkWrap: true,
                        itemCount: filteredItems.length,
                        itemBuilder: (context, index) {
                          final item = filteredItems[index];
                          return ListTile(
                            title: Text(
                                '${item['Numero Os']} : ${item['Emitente OS']} - ${item['Data Emissao']}'),
                            onTap: () {
                              Navigator.of(context)
                                  .pop(item['Numero Os'].toString());
                            },
                          );
                        },
                      ),
                    ),
                  ],
                ),
              );
            },
          );
        },
      );

      if (selected != null) {
        controller = selected;
      }
      return selected;
    } on TimeoutException {
      Navigator.of(_keyLoader.currentContext!, rootNavigator: true).pop();
      _showErrorDialog(
          context, "O tempo limite foi excedido. Tente novamente.");
      return null;
    } catch (error) {
      Navigator.of(_keyLoader.currentContext!, rootNavigator: true).pop();
      _showErrorDialog(context, "Erro ao carregar os dados.");
      return null;
    }
  }

  Future<String?> _showPopupMenu_Osnew(
      BuildContext context, String controller) async {
    final GlobalKey<State> _keyLoader = GlobalKey<State>();

    // Verifica a conexão com a internet
    var connectivityResult = await Connectivity().checkConnectivity();
    if (connectivityResult == ConnectivityResult.none) {
      _showErrorDialog(context, "Sem conexão com a internet.");
      return null;
    }

    // Exibe o diálogo de carregamento
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return Dialog(
          key: _keyLoader,
          child: Container(
            height: 100,
            padding: const EdgeInsets.all(16),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: const [
                CircularProgressIndicator(),
                SizedBox(width: 20),
                Text('Carregando...'),
              ],
            ),
          ),
        );
      },
    );

    try {
      final List<Map<String, dynamic>> items = await fetchDaOs().timeout(
        const Duration(seconds: 18),
        onTimeout: () {
          throw TimeoutException("O tempo limite foi excedido.");
        },
      );

      Navigator.of(_keyLoader.currentContext!, rootNavigator: true)
          .pop(); // Fecha o diálogo de carregamento

      final selected = await showModalBottomSheet<String>(
        context: context,
        isScrollControlled: true,
        builder: (BuildContext context) {
          String searchText = "";
          return StatefulBuilder(
            builder: (context, setState) {
              final List<Map<String, dynamic>> filteredItems =
                  items.where((item) {
                final os = (item['Numero Os']?.toString() ?? "").toLowerCase();
                final emit =
                    (item['Emitente OS']?.toString() ?? "").toLowerCase();
                return os.contains(searchText) || emit.contains(searchText);
              }).toList();

              return SafeArea(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    const Padding(
                      padding: EdgeInsets.all(16.0),
                      child: Text(
                        'Selecione a Ordem de Serviço:',
                        style: TextStyle(
                            fontSize: 18, fontWeight: FontWeight.bold),
                      ),
                    ),
                    Padding(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 16.0, vertical: 8.0),
                      child: TextField(
                        autofocus: true,
                        decoration: const InputDecoration(
                          hintText: "Pesquise por OS ou Emitente",
                          prefixIcon: Icon(Icons.search),
                          border: OutlineInputBorder(),
                        ),
                        onChanged: (value) {
                          setState(() {
                            searchText = value.toLowerCase();
                          });
                        },
                      ),
                    ),
                    Expanded(
                      child: ListView.builder(
                        shrinkWrap: true,
                        itemCount: filteredItems.length,
                        itemBuilder: (context, index) {
                          final item = filteredItems[index];
                          return ListTile(
                            title: Text(
                                '${item['Numero Os']} : ${item['Emitente OS']} - ${item['Data Emissao']}'),
                            onTap: () {
                              Navigator.of(context)
                                  .pop(item['Numero Os'].toString());
                            },
                          );
                        },
                      ),
                    ),
                  ],
                ),
              );
            },
          );
        },
      );

      if (selected != null) {
        controller = selected;
      }
      return selected;
    } on TimeoutException {
      Navigator.of(_keyLoader.currentContext!, rootNavigator: true).pop();
      _showErrorDialog(
          context, "O tempo limite foi excedido. Tente novamente.");
      return null;
    } catch (error) {
      Navigator.of(_keyLoader.currentContext!, rootNavigator: true).pop();
      _showErrorDialog(context, "Erro ao carregar os dados.");
      return null;
    }
  }

// Função para exibir mensagens de erro
  void _showErrorDialog(BuildContext context, String message) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: const Text("Erro"),
          content: Text(message),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text("OK"),
            ),
          ],
        );
      },
    );
  }

  Uint8List? imageBytes;
  Future<void> pegarImagemGet() async {
    if (selectedcode == null) return;

    setState(() {
      isLoading2 = true;
      imageBytes = null;
      isImageAvailable = false;
    });

    // final String username = "IPENA";
    // final String password = "Nina@2010";SALDPR?page=1&limit=50
    final username = widget.user;
    final password = widget.senha;
    final String baseUrl = "http://192.168.0.6:80/REST/ipena_insol/mt010images";
    final String url = "$baseUrl?product=$selectedcode";

    String basicAuth =
        'Basic ' + base64Encode(utf8.encode('$username:$password'));

    try {
      final response = await http.get(
        Uri.parse(url),
        headers: {'Authorization': basicAuth},
      );

      if (response.statusCode == 200 && response.bodyBytes.isNotEmpty) {
        setState(() {
          imageBytes = response.bodyBytes;
          isImageAvailable = true;
        });
      } else {
        setState(() {
          imageBytes = null;
          isImageAvailable = false;
        });
      }
    } catch (e) {
      setState(() {
        imageBytes = null;
        isImageAvailable = false;
      });
      print('Erro: $e');
    } finally {
      setState(() {
        isLoading2 = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        automaticallyImplyLeading: false,
        title: const Text(
          'Solicitação de Produtos',
          style: TextStyle(
            fontSize: 24,
            fontWeight: FontWeight.bold,
          ),
        ),
        backgroundColor: Colors.blueAccent,
        elevation: 4,
      ),
      body: isLoading
          ? Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  CircularProgressIndicator(
                    color: Colors.blueAccent,
                    strokeWidth: 6.0,
                  ),
                  const SizedBox(height: 20),
                  const Text(
                    'Carregando...',
                    style: TextStyle(fontSize: 18, color: Colors.grey),
                  ),
                ],
              ),
            )
          : hasError
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.error_outline,
                          size: 80, color: Colors.redAccent),
                      const SizedBox(height: 10),
                      const Text(
                        'Erro ao carregar dados.',
                        style: TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                            color: Colors.redAccent),
                      ),
                      const SizedBox(height: 20),
                      ElevatedButton.icon(
                        onPressed: fetchData1,
                        icon: const Icon(Icons.refresh, color: Colors.white),
                        label: const Text('Tentar Novamente'),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.blueAccent,
                          shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(10)),
                          padding: const EdgeInsets.symmetric(
                              horizontal: 20, vertical: 10),
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton.icon(
                        onPressed: fetchDataof,
                        icon:
                            const Icon(Icons.offline_bolt, color: Colors.white),
                        label: const Text('Usar dados offline'),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.green,
                          shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(10)),
                          padding: const EdgeInsets.symmetric(
                              horizontal: 20, vertical: 10),
                        ),
                      ),
                    ],
                  ),
                )
              : Padding(
                  padding: const EdgeInsets.all(12.0),
                  child: Column(
                    children: [
                      Expanded(
                        child: Row(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // Tabela de Dados ajustada com estilo mais moderno
                            Expanded(
                              flex: 3,
                              child: _buildStyledCard(
                                child: _buildDataRow1('Pesquisas'),
                              ),
                            ),
                            const SizedBox(width: 10),
                            // Linha 2 ajustada com estilo mais moderno
                            Expanded(
                              flex: 2,
                              child: _buildStyledCard(
                                child: _buildDataRow2('Itens Adicionados'),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
    );
  }
}

// Método para estilizar os cards de conteúdo
Widget _buildStyledCard({required Widget child}) {
  return Card(
    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
    elevation: 6,
    margin: const EdgeInsets.symmetric(vertical: 10),
    child: Padding(
      padding: const EdgeInsets.all(10),
      child: child,
    ),
  );
}
